<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECalc v4.1 - Modular Architecture Demo</title>
    <!-- Error Handler - Must load first to prevent console auto-opening -->
    <script src="js/error-handler.js"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.2rem;
        }
        
        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .module-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
        }
        
        .module-card.core {
            border-top: 4px solid #667eea;
        }
        
        .module-card.business {
            border-top: 4px solid #48bb78;
        }
        
        .module-card h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-badge.ready {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-badge.loading {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .metric-value {
            color: #333;
            font-weight: 600;
        }
        
        .demo-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .demo-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .calculator-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .button:hover {
            transform: scale(1.05);
        }
        
        .results {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .event-log {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .event-entry {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .health-stat {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .health-stat .value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .health-stat .label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ ECalc v4.1 - Modular Architecture</h1>
            <div class="subtitle">Enterprise-Grade Module System with DI, Event Bus & Health Monitoring</div>
        </div>

        <!-- Module Status Grid -->
        <div class="architecture-grid">
            <!-- Core Modules -->
            <div class="module-card core">
                <h3>
                    üì¶ Container
                    <span class="status-badge ready">Ready</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Services Registered</span>
                    <span class="metric-value">12</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Singletons</span>
                    <span class="metric-value">8</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Dependencies Resolved</span>
                    <span class="metric-value">24</span>
                </div>
            </div>

            <div class="module-card core">
                <h3>
                    üì° Event Bus
                    <span class="status-badge ready">Active</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Events Processed</span>
                    <span class="metric-value" id="eventCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Listeners</span>
                    <span class="metric-value">15</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Wildcard Patterns</span>
                    <span class="metric-value">3</span>
                </div>
            </div>

            <div class="module-card core">
                <h3>
                    ‚öôÔ∏è Configuration
                    <span class="status-badge ready">Loaded</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Environment</span>
                    <span class="metric-value">Development</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Config Sources</span>
                    <span class="metric-value">3</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Hot Reload</span>
                    <span class="metric-value">Enabled</span>
                </div>
            </div>

            <div class="module-card core">
                <h3>
                    üìä Monitoring
                    <span class="status-badge ready">Running</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Health Checks</span>
                    <span class="metric-value" id="healthChecks">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptime">0s</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory</span>
                    <span class="metric-value" id="memory">0MB</span>
                </div>
            </div>

            <!-- Business Modules -->
            <div class="module-card business">
                <h3>
                    üßÆ Calculation Engine
                    <span class="status-badge ready">Ready</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Calculations</span>
                    <span class="metric-value" id="calcCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cache Hit Rate</span>
                    <span class="metric-value">78%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response</span>
                    <span class="metric-value">45ms</span>
                </div>
            </div>

            <div class="module-card business">
                <h3>
                    üîç Customer Enrichment
                    <span class="status-badge ready">Ready</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Enrichments</span>
                    <span class="metric-value" id="enrichCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Providers</span>
                    <span class="metric-value">3 Active</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Success Rate</span>
                    <span class="metric-value">94%</span>
                </div>
            </div>

            <div class="module-card business">
                <h3>
                    üìÑ PDF Generator
                    <span class="status-badge ready">Ready</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">PDFs Generated</span>
                    <span class="metric-value">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Templates</span>
                    <span class="metric-value">3</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Queue Size</span>
                    <span class="metric-value">0</span>
                </div>
            </div>

            <div class="module-card business">
                <h3>
                    üîÑ Zoho Sync
                    <span class="status-badge loading">Offline</span>
                </h3>
                <div class="metric">
                    <span class="metric-label">Sync Queue</span>
                    <span class="metric-value">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Last Sync</span>
                    <span class="metric-value">N/A</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value">Disabled</span>
                </div>
            </div>
        </div>

        <!-- Interactive Demo -->
        <div class="demo-section">
            <h2>üéØ Live Modular Calculation Demo</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Test the modular architecture with a real calculation. Watch as modules communicate via events!
            </p>
            
            <div class="calculator-form">
                <div class="form-group">
                    <label>Generator Size (kW)</label>
                    <input type="number" id="kw" value="100" min="10" max="1000">
                </div>
                <div class="form-group">
                    <label>Distance (miles)</label>
                    <input type="number" id="distance" value="50" min="0" max="500">
                </div>
                <div class="form-group">
                    <label>Unit Count</label>
                    <input type="number" id="unitCount" value="1" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Services</label>
                    <select id="services" multiple style="height: 200px;">
                        <option value="A" selected>Service A - Comprehensive Inspection</option>
                        <option value="B" selected>Service B - Oil & Filter Service</option>
                        <option value="C">Service C - Coolant Service</option>
                        <option value="D">Service D - Oil & Fuel Analysis</option>
                        <option value="E">Service E - Load Bank Testing</option>
                        <option value="F">Service F - Engine Tune-Up (Diesel)</option>
                        <option value="G">Service G - Gas Engine Tune-Up</option>
                        <option value="H">Service H - Generator Electrical Testing</option>
                        <option value="I">Service I - Transfer Switch Service</option>
                        <option value="J">Service J - Thermal Imaging Scan</option>
                        <option value="K">Service K - Battery Replacement</option>

                    </select>
                </div>
            </div>
            
            <button class="button" onclick="performCalculation()">
                Calculate with Modular System
            </button>
            
            <div class="results" id="results" style="display: none;">
                <h3>üìä Calculation Results</h3>
                <div id="resultContent"></div>
            </div>
        </div>

        <!-- Event Bus Monitor -->
        <div class="demo-section">
            <h2>üì° Event Bus Activity Monitor</h2>
            <p style="color: #666;">Real-time view of inter-module communication</p>
            <div class="event-log" id="eventLog">
                <div class="event-entry">[SYSTEM] Event bus initialized...</div>
                <div class="event-entry">[READY] Waiting for module events...</div>
            </div>
        </div>

        <!-- System Health -->
        <div class="demo-section">
            <h2>üè• System Health Dashboard</h2>
            <div class="health-grid">
                <div class="health-stat">
                    <div class="value" id="healthScore">100%</div>
                    <div class="label">Health Score</div>
                </div>
                <div class="health-stat">
                    <div class="value" id="moduleCount">8</div>
                    <div class="label">Active Modules</div>
                </div>
                <div class="health-stat">
                    <div class="value" id="apiLatency">0ms</div>
                    <div class="label">API Latency</div>
                </div>
                <div class="health-stat">
                    <div class="value" id="cacheHitRate">0%</div>
                    <div class="label">Cache Hit Rate</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulated Event Bus for demo
        class EventBus {
            constructor() {
                this.events = {};
                this.eventCount = 0;
            }

            emit(event, data) {
                this.eventCount++;
                this.logEvent('EMIT', event, data);
                document.getElementById('eventCount').textContent = this.eventCount;
                
                if (this.events[event]) {
                    this.events[event].forEach(callback => callback(data));
                }
            }

            on(event, callback) {
                if (!this.events[event]) {
                    this.events[event] = [];
                }
                this.events[event].push(callback);
                this.logEvent('LISTEN', event);
            }

            logEvent(type, event, data) {
                const log = document.getElementById('eventLog');
                const entry = document.createElement('div');
                entry.className = 'event-entry';
                const timestamp = new Date().toLocaleTimeString();
                
                if (data) {
                    entry.textContent = `[${timestamp}] [${type}] ${event} ‚Üí ${JSON.stringify(data).substring(0, 100)}`;
                } else {
                    entry.textContent = `[${timestamp}] [${type}] Registered listener for: ${event}`;
                }
                
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }
        }

        const eventBus = new EventBus();
        
        // Simulate module communication
        eventBus.on('calc:request', (data) => {
            setTimeout(() => {
                eventBus.emit('calc:processing', { id: data.id, status: 'calculating' });
            }, 100);
        });

        eventBus.on('calc:processing', (data) => {
            setTimeout(() => {
                eventBus.emit('calc:complete', { 
                    id: data.id, 
                    result: { total: Math.random() * 10000 + 5000 }
                });
            }, 300);
        });

        eventBus.on('calc:complete', (data) => {
            eventBus.emit('pdf:generate', { calculation: data.result });
            eventBus.emit('zoho:queue', { data: data.result });
        });

        // Update counters
        let calcCount = 0;
        let enrichCount = 0;
        let healthChecks = 0;
        let uptime = 0;

        setInterval(() => {
            uptime++;
            document.getElementById('uptime').textContent = `${uptime}s`;
            
            if (uptime % 30 === 0) {
                healthChecks++;
                document.getElementById('healthChecks').textContent = healthChecks;
                eventBus.emit('monitoring:healthCheck', { timestamp: Date.now() });
            }
            
            // Simulate memory usage
            const memory = Math.floor(Math.random() * 50 + 250);
            document.getElementById('memory').textContent = `${memory}MB`;
        }, 1000);

        async function performCalculation() {
            const kw = document.getElementById('kw').value;
            const distance = document.getElementById('distance').value;
            const unitCount = document.getElementById('unitCount').value;
            const servicesSelect = document.getElementById('services');
            const services = Array.from(servicesSelect.selectedOptions).map(opt => opt.value);
            
            calcCount++;
            document.getElementById('calcCount').textContent = calcCount;
            
            // Emit calculation request event
            const requestId = `CALC_${Date.now()}`;
            eventBus.emit('calc:request', {
                id: requestId,
                kw: parseInt(kw),
                distance: parseInt(distance),
                unitCount: parseInt(unitCount),
                services
            });

            // Simulate API call
            const startTime = Date.now();
            
            try {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kw, distance, unitCount, services })
                });
                
                const latency = Date.now() - startTime;
                document.getElementById('apiLatency').textContent = `${latency}ms`;
                
                if (response.ok) {
                    const data = await response.json();
                    displayResults(data);
                    eventBus.emit('calc:apiResponse', { latency, success: true });
                } else {
                    // Fallback calculation
                    const mockData = calculateLocally(kw, distance, unitCount, services);
                    displayResults(mockData);
                    eventBus.emit('calc:fallback', { reason: 'API unavailable' });
                }
            } catch (error) {
                // Fallback calculation
                const mockData = calculateLocally(kw, distance, unitCount, services);
                displayResults(mockData);
                eventBus.emit('calc:error', { error: error.message });
            }
            
            // Update cache hit rate
            const hitRate = Math.floor(Math.random() * 20 + 70);
            document.getElementById('cacheHitRate').textContent = `${hitRate}%`;
            
            // Simulate enrichment
            enrichCount++;
            document.getElementById('enrichCount').textContent = enrichCount;
            eventBus.emit('enrichment:complete', { count: enrichCount });
        }

        function calculateLocally(kw, distance, unitCount, services) {
            const laborRate = 175;
            const basePrice = kw * 50 * unitCount;
            const shopCost = distance * 2 * laborRate;  // Shop prep cost calculation
            const serviceCost = services.length * 500;
            const subtotal = basePrice + shopCost + serviceCost;
            const tax = subtotal * 0.1025;
            const total = subtotal + tax;
            
            return {
                laborRate,
                basePrice,
                shopCost,
                serviceCost,
                subtotal,
                tax,
                totalWithTax: total,
                services: services.join(', ')
            };
        }

        function displayResults(data) {
            const results = document.getElementById('results');
            const content = document.getElementById('resultContent');
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <strong>Labor Rate:</strong> $${data.laborRate}/hr
                    </div>
                    <div>
                        <strong>Base Price:</strong> $${data.basePrice?.toFixed(2) || '0.00'}
                    </div>
                    <div>
                        <strong>Shop Time Cost:</strong> $${data.shopCost?.toFixed(2) || '0.00'}
                    </div>
                    <div>
                        <strong>Service Cost:</strong> $${data.serviceCost?.toFixed(2) || '0.00'}
                    </div>
                    <div>
                        <strong>Subtotal:</strong> $${data.subtotal?.toFixed(2) || '0.00'}
                    </div>
                    <div>
                        <strong>Tax:</strong> $${data.tax?.toFixed(2) || '0.00'}
                    </div>
                    <div style="grid-column: span 2; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                        <strong style="font-size: 1.2rem; color: #667eea;">
                            Total: $${data.totalWithTax?.toFixed(2) || '0.00'}
                        </strong>
                    </div>
                </div>
            `;
            
            results.style.display = 'block';
            
            // Emit result display event
            eventBus.emit('ui:resultsDisplayed', { total: data.totalWithTax });
        }

        // Initialize with some events
        window.addEventListener('load', () => {
            eventBus.emit('app:initialized', { version: '4.1.0' });
            eventBus.emit('modules:loaded', { count: 8 });
            
            // Simulate module registration
            setTimeout(() => {
                eventBus.emit('module:registered', { name: 'calculation-engine' });
                eventBus.emit('module:registered', { name: 'customer-enrichment' });
                eventBus.emit('module:registered', { name: 'pdf-generator' });
                eventBus.emit('module:registered', { name: 'zoho-sync' });
            }, 500);
        });
    </script>
</body>
</html>